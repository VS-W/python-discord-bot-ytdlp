<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<link rel="shortcut icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjgiIGhlaWdodD0iMTI4IiB2aWV3Qm94PSIwIDAgMzMuODY3IDMzLjg2NyIgc3Ryb2tlPSIjMDAwIiB4bWxuczp2PSJodHRwczovL3ZlY3RhLmlvL25hbm8iPjxwYXRoIGQ9Ik0zMi45NzEgMjguNzE3Yy0zLjE5NCA1LjUzMi0yOC43NDMgNS41MzItMzEuOTM3IDBTMTAuNjE1IDEuMDU5IDE3LjAwMiAxLjA1OXMxOS4xNjIgMjIuMTI3IDE1Ljk2OSAyNy42NTh6IiBmaWxsPSIjZTZlNmU2IiBzdHJva2Utd2lkdGg9Ii4wMDEiLz48cGF0aCBkPSJNMjIuNTg5IDMyLjYxM2MtLjYzMi43NzMtMTAuNTQxLjc3My0xMS4xNzMgMHMtLjYzMi0xMi44ODQgMC0xMy42NTYgMTAuNTQxLS43NzMgMTEuMTczIDAgLjYzMiAxMi44ODQgMCAxMy42NTZ6IiBmaWxsPSIjMzMzIiBzdHJva2Utd2lkdGg9Ii4wMDIiLz48L3N2Zz4=" />
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Nunito&display=swap" rel="stylesheet">

	<title>Downloads</title>

	<style>
		body {
			background: rgb(32, 32, 32);
			display: flex;
			flex-direction: column;
			align-items: center;
		}

		h1 {
			font-family: "Nunito", sans-serif;
			color: white;
			font-size: 2em;
			margin: 0.3em;
		}

		#container {
			display: flex;
			flex-direction: row;
			flex-wrap: wrap;
			justify-content: space-evenly;
			width: 90%;
		}

		.outercontainer {
			display: flex;
			flex-direction: row;
			width: 250px;
			padding: 0.5em;
		}

		.outercontainer a {
			border: 2px #ffffff00 solid;
			text-decoration: none;
			color: white;
		}

		.outercontainer > a:hover {
			border: 2px #e4b5ff solid;
		}

		.namecontainer {
			display: flex;
			flex-direction: column;
			width: 250px;
			overflow: hidden;
		}
		.namecontainer a {
			font-family: "Nunito", sans-serif;
			color: white;
			font-size: 1em;
			text-decoration: none;
			text-align: left;

			display: -webkit-box;
			-webkit-line-clamp: 2;
			line-clamp: 2; 
			-webkit-box-orient: vertical;
		}

		.thumbnail {
			width: 250px;
			max-height: 141px;
			object-fit: cover;
		}

		#nav {
			display: flex;
			flex-direction: row;
			width: 90%;
			justify-content: space-evenly;
			align-items: center;
		}
		.nav-page {
			font-family: "Nunito", sans-serif;
			color: white;
			font-size: 1em;
			text-decoration: none;
		}
		.nav-page:hover {
			font-family: "Nunito", sans-serif;
			color: #e4b5ff;
			font-size: 1em;
		}
		.hidden {
			visibility: hidden;
		}
	</style>
</head>
<body>
	<div id="nav">
		<a class="nav-page hidden" id="prev" href="#">⮜ Previous</a>
		<h1>Downloads</h1>
		<a class="nav-page hidden" id="next" href="#">Next ⮞</a>
	</div>
	<div id="container"></div>
	<script>
		let logged = [];
		let reconnect_timeout = 2000;
		let db_max = 1;

		getFilelist('max_count=20').then((res) => {
			replaceList(buildLinks(res));
		});

		setTimeout(initSSE, 2000);
		initNavButtons();

		function initNavButtons() {
			document.getElementById('next').addEventListener('click', (e) => {
				e.preventDefault();
				logged = [];
				let range = getRange();
				getFilelist(`max_row=${range.nextPage[0]}&min_row=${range.nextPage[1]}`).then((res) => {
					replaceList(buildLinks(res));
				});
			});
			document.getElementById('prev').addEventListener('click', (e) => {
				e.preventDefault();
				logged = [];
				let range = getRange();
				getFilelist(`max_row=${range.prevPage[0]}&min_row=${range.prevPage[1]}`).then((res) => {
					if (res.length < 20 && res[0].id > 20) {
						getFilelist(`max_row=${res[0].id}`).then((res) => {
							replaceList(buildLinks(res));
						});
					} else {
						replaceList(buildLinks(res));
					}
				});
			});
		}

		function getRange() {
			let elArr = document.querySelectorAll('.outercontainer');
			let idArr = [];
			elArr.forEach(el => {
				idArr.push(el.getAttribute('seq_id'));
			});
			if (idArr.length > 0) {
				let max = Math.max(...idArr);
				let min = Math.min(...idArr);
				let nextPage = [min - 1, min - 20];
				let prevPage = [max + 20, max + 1];
				return {
					'max': max,
					'min': min,
					'nextPage': nextPage,
					'prevPage': prevPage,
					'count': idArr.length
				}
			} else {
				return {
					'max': 1,
					'min': 1,
					'nextPage': [1, 1],
					'prevPage': [1, 1],
					'count': 0
				}
			}
		}

		function navButtons() {
			let range = getRange();

			if (range['min'] > 1) {
				showEl('next');
			} else {
				hideEl('next');
			}

			if (db_max > range['max']) {
				showEl('prev');
			} else {
				hideEl('prev');
			}
		}

		function hideEl(id) {
			document.getElementById(id).classList.add('hidden');
		}

		function showEl(id) {
			document.getElementById(id).classList.remove('hidden');
		}

		function appendList(elArr) {
			let mainContainer = document.querySelector('#container');
			elArr.forEach(el => {
				mainContainer.prepend(el);
				if (mainContainer.children.length > 20) {
					mainContainer.removeChild(mainContainer.lastChild);
				}
			});
			navButtons();
		}

		function replaceList(elArr) {
			let mainContainer = document.querySelector('#container');
			mainContainer.replaceChildren(...elArr);
			navButtons();
		}

		function stripExtension(filename) {
			const lastDotIndex = filename.lastIndexOf('.');
			if (lastDotIndex == -1) {
				return filename;
			}
			return filename.slice(0, lastDotIndex);
		}

		function buildLinks(arr) {
			let newArr = [];
			arr.forEach(el => {
				if (!logged.includes(el['folder'])) {
					logged.push(el['folder']);

					el['filename'] = encodeURIComponent(el['filename']);
					let elObj = {
						name: el['title'],
						url: el['filename'],
						id: el['id'],
						thumbnail: stripExtension(el['filename']) + '.' + el['thumbnail_ext']
					};
					newArr.push(elObj);
				}
			});

			return newArr.map(el => {
				let linkContainer = document.createElement('a');
				linkContainer.href = el.url;

				let thumbnail = document.createElement('img');
				thumbnail.src = el['thumbnail'];
				thumbnail.classList.add('thumbnail');
				linkContainer.append(thumbnail);

				let nameContainer = document.createElement('div');
				nameContainer.classList.add('namecontainer');
				linkContainer.append(nameContainer);

				let link = document.createElement('a');
				link.href = el.url;
				link.innerText = el.name;
				nameContainer.append(link);

				let outerContainer = document.createElement('div');
				outerContainer.classList.add('outercontainer');
				outerContainer.append(linkContainer);

				outerContainer.setAttribute('seq_id', el['id']);

				return outerContainer;
			});
		}

		async function getFilelist(query) {
			return fetch('/db?' + query, { cache: 'no-cache' }).then(data => {
				return data.text();
			}).then(text => {
				let output = JSON.parse(text)['res'].map((el) => {
					if (el[0] > db_max) {
						db_max = el[0];
					}
					return {
						'id': el[0],
						'folder': el[1],
						'filename': el[2],
						'title': el[3],
						'video_id': el[4],
						'thumbnail_ext': el[5]
					}
				});
				return output;
			});
		}

		function initSSE() {
			sse = new EventSource('/sse');

			sse.onopen = (event) => {
				reconnect_timeout = 2000;
			};

			sse.onmessage = (event) => {
				let inputData = JSON.parse(event.data)['data'];

				let range = getRange();
				if (range['max'] == db_max) {
					db_max = inputData['id'];
					appendList(buildLinks([inputData]));
				} else {
					db_max = inputData['id'];
				}
			};

			sse.onerror = (event) => {
				sse.close();
				setTimeout(reconnect, reconnect_timeout);
			};
		}

		function reconnect() {
			if (reconnect_timeout < 60000) {
				reconnect_timeout += (Math.random() * 2000) + 3000;
			}
			initSSE();
		}
	</script>
</body>

</html>
