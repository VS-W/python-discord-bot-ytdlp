<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<link rel="shortcut icon" href="data:image/x-icon;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADsUlEQVRYw7WXy28bVRSHv3l4PH5M4oRkrsi0FY+UlhSVt1ggoSIqoCCxqZBYwIo/gEpsuikbBAgVsYA/oAs2rNiAoErTRRFIVBQIUtMFqyjpVJ1R4jzscZxxZoaF7WTijONH7bM85/h+5/x879xzJfow17F14HVgpuFaiGBWCGu717WkHsEa8BFwERhvCa8Cn0VI3wgxFQy8ANexHwN+AJ7ukHoTeNcU1nI368pdwl8GbiXBgx2fzY37hOFu0y8Bf7iO/cxACmjAZ4GxpHitVsXfLlPxinH3FHDddezTD1SA69jHgZ+AbLscRdXqSgR+a2gc+Nl17KOHMdruAdexDeAf4PE6oMbm+j0kWaEwdmRfbrVaQlVSqCk9aalbwCumsLZ6VeBKEw7glVcIghqKrB5I1HWjHRzgBeByTwq4jv0+8F3cVy6tEEUBufwEsqzQh71lCuuXjgW4jj0B/EebTXeYRVFEEPioajopvATMmMLy4s6kv+DLfuBhGLBeXGK9uIzvV5JSjgGfHKpA49j82yscoOKtUfFWUZQUhfGjSFLi9qoCT5rCWmw6WnfUp62/8P0K1a0NJEkml38IOWETAqT1PLIsk9aNdnAAHbgEfHhAgXbdb6zdpVarAmCMCNK60Y9AcQuA6aYK8XYuJGVn8ia/XvuRbb+GnhnpmnJi+gkeOXaEMAzQtExcFaXBurCrgOvYY4ANZFoX+mv+bz6+fLHnNg09y5UvvgIgpWUZLUzFw2uAZQprq1nW+SQ4gF+r9aVzqVpBS+fRtBzZ7IFDNQa8A3vH8HxflE4qjApGCg+T0hJ7ew9Adpx7KeDVYRTQwc66zl1ZlYheBA58usIwIAx3iKJwWAXkQXpeBU61RipekYq3BkSUNu8PU4XTMvXhYdeqWxuN4SIaKMnf9lqHFgBLBfZNEjV/79pWUzp5w3xgeLVaorzpAKBnRuO36Y4K/BlPzhmTpNI5FFklpWWQZXsA3ZcByBuTrVf5TdkU1hww3/TIsoKuG+2OTl9mjAjGJx5Fz4zG3fOmsK43vwMfAF7vS3dnkiS3du41mPUPkSms28CbwMqwiojZKvBGg7k3kJjC+g14Drg6RPhV4FlTWL83HfsublNYy6awzlF/990YIPhGo+tzrS+mxMnBFNY1U1hngOnFpcXv+8ZGXAKOm8I6YwprNiml49tw5uypSeBb4G0g3yV6Ffj6ztzC550Su36cnnjtpKRIylPASerXaQFojkcVoAisAwt35hZud7vu/028G+jXb+4+AAAAAElFTkSuQmCC" />
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Nunito&display=swap" rel="stylesheet">

	<title>Downloads</title>

	<style>
		body {
			background: rgb(32, 32, 32);
			display: flex;
			flex-direction: column;
			align-items: center;
		}

		h1 {
			font-family: "Nunito", sans-serif;
			color: white;
			font-size: 2em;
			margin: 0.3em;
		}

		#container {
			display: flex;
			flex-direction: row;
			flex-wrap: wrap;
			justify-content: space-evenly;
			width: 90%;
		}

		.outercontainer {
			display: flex;
			flex-direction: row;
			width: 250px;
			padding: 0.5em;
		}

		.outercontainer a {
			border: 2px #ffffff00 solid;
			text-decoration: none;
			color: white;
		}

		.outercontainer > a:hover {
			border: 2px #704a86 solid;
		}

		.namecontainer {
			display: flex;
			flex-direction: column;
			width: 250px;
			overflow: hidden;
		}
		.namecontainer a {
			font-family: "Nunito", sans-serif;
			color: white;
			font-size: 1em;
			text-decoration: none;
			text-align: left;

			display: -webkit-box;
			-webkit-line-clamp: 2;
			line-clamp: 2; 
			-webkit-box-orient: vertical;
		}

		.thumbnail {
			width: 250px;
			max-height: 141px;
			object-fit: cover;
		}
	</style>
</head>

<body>
	<h1>Downloads</h1>
	<div id="container"></div>
	<script>
		let logged = [];
		let reconnect_timeout = 2000;

		getFilelist();
		setTimeout(initSSE, 2000);

		function stripExtension(filename) {
			const lastDotIndex = filename.lastIndexOf('.');
			if (lastDotIndex == -1) {
				return filename;
			}
			return filename.slice(0, lastDotIndex);
		}

		function appendList(arr) {
			let newArr = [];

			// console.log(arr);
			// console.log(arr.sort((a, b) => {return a.id - b.id;}));
			arr.sort((a, b) => {return a.id - b.id;}).forEach(el => {
				if (!logged.includes(el["folder"])) {
					logged.push(el["folder"]);
					let elObj = {
						name: el["title"],
						url: encodeURIComponent(el["filename"]),
						id: el['id']
					};

					if (el["thumbnail_ext"]) {
						elObj["thumbnail"] = stripExtension(encodeURIComponent(el["filename"])) + "." + el["thumbnail_ext"];
					}
					newArr.push(elObj);
				}
			});

			newArr.forEach(el => {
				let linkContainer = document.createElement('a');
				linkContainer.href = el.url;

				let thumbnail = document.createElement('img');
				thumbnail.src = el['thumbnail'];
				thumbnail.classList.add('thumbnail');
				linkContainer.append(thumbnail);

				let nameContainer = document.createElement('div');
				nameContainer.classList.add('namecontainer');
				linkContainer.append(nameContainer);

				let link = document.createElement('a');
				link.href = el.url;
				link.innerText = el.name;
				nameContainer.append(link);

				let outerContainer = document.createElement('div');
				outerContainer.classList.add('outercontainer');
				outerContainer.append(linkContainer);

				let mainContainer = document.querySelector('#container');
				mainContainer.prepend(outerContainer);
				if (mainContainer.children.length > 20) {
					mainContainer.removeChild(mainContainer.lastChild);
				}
			});
		}

		function getFilelist() {
			fetch("/db?max_count=20", { cache: "no-cache" }).then(data => {
				data.text().then(
					jsonText => {
						try {
							let output = JSON.parse(jsonText)["res"].map((el) => {
								return {
									"id": el[0],
									"folder": el[1],
									"filename": el[2],
									"title": el[3],
									"video_id": el[4],
									"thumbnail_ext": el[5]
								}
							});
							appendList(output);
						} catch (e) {
							console.log(e);
						}
					}
				)
			});
		}

		function initSSE() {
			sse = new EventSource("/sse");

			sse.onopen = (event) => {
				reconnect_timeout = 2000;
			};

			sse.onmessage = (event) => {
				appendList([JSON.parse(event.data)['data']]);
			};

			sse.onerror = (event) => {
				sse.close();
				setTimeout(reconnect, reconnect_timeout);
			};
		}

		function reconnect() {
			if (reconnect_timeout < 60000) {
				reconnect_timeout += (Math.random() * 2000) + 3000;
			}
			initSSE();
		}
	</script>
</body>

</html>
